---
import HeaderPage from "../../components/HeaderPage.astro";
import Layout from "../../layouts/Layout.astro";
import PocketBase from "pocketbase";
import "../../styles/global.css";
import LinkInterpretation from "../../components/LinkInterpretation.astro";

export const prerender = false;

const pb = new PocketBase("https://sae303.pockethost.io");

const { id } = Astro.params;

if (!id) {
  console.error("‚ùå ID manquant pour la page formation.");
  throw new Error("ID manquant pour la page formation.");
}

let formation = null;

try {
  console.log(
    "üì° R√©cup√©ration de la formation avec ses interpr√©tations et leurs ≈ìuvres..."
  );

  // üî• Correction : Ajout de "interpretations.titre_oeuvre" pour r√©cup√©rer l'≈ìuvre associ√©e √† chaque interpr√©tation
  formation = await pb.collection("formations").getOne(id, {
    expand: "interpretations.titre_oeuvre",
  });

  console.log("‚úÖ Formation r√©cup√©r√©e :", formation);
} catch (error) {
  console.error("‚ùå Erreur lors de la r√©cup√©ration :", error);
}

const baseUrl = "https://sae303.pockethost.io";
---

<HeaderPage />

<Layout
  pageTitle={formation
    ? `D√©tails de ${formation.nom_groupe}`
    : "Formation introuvable"}
>
  <section
    class="flex flex-col items-center min-h-screen bg-gradient-to-b from-gray-900 to-gray-700 text-white py-12"
  >
    {
      formation ? (
        <>
          <h1 class="text-4xl font-bold mb-6 tracking-wide">
            {formation.nom_groupe}
          </h1>

          {formation.photo && (
            <img
              src={`${baseUrl}/api/files/formations/${formation.id}/${formation.photo}`}
              alt={`Photo de ${formation.nom_groupe}`}
              class="w-32 h-32 mx-auto mb-4 rounded-full object-cover"
            />
          )}

          {formation.expand?.interpretations &&
          formation.expand.interpretations.length > 0 ? (
            <div class="p-4 bg-gray-800 rounded-lg w-full max-w-3xl">
              <h2 class="text-2xl font-semibold mb-3">Interpr√©tations :</h2>
              <ul class="list-disc pl-5 space-y-1">
                {formation.expand.interpretations.map((interpretation) => (
                  <li key={interpretation.id}>
                    <div>
                      <LinkInterpretation interpretation={interpretation} />
                      {interpretation.annee_sortie && (
                        <p class="text-sm text-gray-400">
                          Ann√©e de sortie : {interpretation.annee_sortie}
                        </p>
                      )}
                    </div>

                    {interpretation.expand?.titre_oeuvre && (
                      <div class="flex items-center space-x-3 mt-2">
                        {interpretation.expand.titre_oeuvre.cover && (
                          <img
                            src={`${baseUrl}/api/files/oeuvres/${interpretation.expand.titre_oeuvre.id}/${interpretation.expand.titre_oeuvre.cover}`}
                            alt={`Cover de ${interpretation.expand.titre_oeuvre.titre}`}
                            class="w-16 h-16 rounded-lg object-cover"
                          />
                        )}

                        <p class="text-sm text-gray-400">
                          ≈íuvre originale :{" "}
                          <a
                            href={`/oeuvres/${interpretation.expand.titre_oeuvre.id}`}
                            class="text-blue-400 hover:underline"
                          >
                            {interpretation.expand.titre_oeuvre.titre}
                          </a>
                          {interpretation.expand.titre_oeuvre.annee}
                        </p>
                      </div>
                    )}
                  </li>
                ))}
              </ul>
            </div>
          ) : (
            <p class="text-yellow-400 text-center">
              Aucune interpr√©tation trouv√©e.
            </p>
          )}
        </>
      ) : (
        <p class="text-red-500 text-center">Formation introuvable.</p>
      )
    }
  </section>
</Layout>
