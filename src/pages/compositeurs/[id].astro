---
import HeaderPage from "../../components/HeaderPage.astro";
import Layout from "../../layouts/Layout.astro";
import LinkOeuvre from "../../components/LinkOeuvre.astro";
import type {
  OeuvresResponse,
  CompositeursResponse,
} from "../../pocketbase-typegen";
import "../../styles/global.css"; // Import propre du CSS

const { id } = Astro.params;

console.log("üîç ID re√ßu depuis les param√®tres :", id);

if (!id) {
  console.error("‚ùå ID manquant pour la page ≈ìuvre.");
  throw new Error("ID manquant pour la page ≈ìuvre.");
}

let compositeur = null;

try {
  console.log(
    "üì° Tentative de r√©cup√©ration du compositeur depuis PocketBase..."
  );

  compositeur = await Astro.locals.pb
    .collection<
      CompositeursResponse<{ oeuvres?: OeuvresResponse[] }>
    >("compositeurs")
    .getOne(id, { expand: "oeuvres" });

  console.log("‚úÖ Compositeur r√©cup√©r√© avec succ√®s :", compositeur);
} catch (error) {
  console.error("‚ùå Erreur lors de la r√©cup√©ration du compositeur :", error);
}

const baseUrl = "http://127.0.0.1:8090"; // URL de base de PocketBase
---

<head>
  <link rel="stylesheet" href="/src/styles/global.css" />
</head>

<HeaderPage />
<Layout
  pageTitle={compositeur
    ? `D√©tails de ${compositeur.nom}`
    : "Compositeur introuvable"}
>
  <section
    class="flex flex-col items-center min-h-screen bg-gradient-to-b from-gray-900 to-gray-700 text-white py-12"
  >
    {
      compositeur ? (
        <>
          <h1 class="text-4xl font-bold mb-6 tracking-wide">
            {compositeur.nom}
          </h1>

          {/* V√©rifier et afficher les ≈ìuvres */}
          {compositeur.expand?.oeuvres &&
            compositeur.expand.oeuvres.length > 0 && (
              <p class="text-lg">
                A compos√© :
                <ul>
                  {compositeur.expand.oeuvres.map((oeuvre) => (
                    <li key={oeuvre.id}>
                      <LinkOeuvre
                        oeuvres={{
                          id: oeuvre.id,
                          titre: oeuvre.titre,
                        }}
                      />
                    </li>
                  ))}
                </ul>
              </p>
            )}

          {compositeur.photo && (
            <img
              src={`${baseUrl}/api/files/compositeurs/${compositeur.id}/${compositeur.photo}`}
              alt={`Photo de ${compositeur.nom}`}
              class="w-32 h-32 mx-auto mb-4 object-cover"
            />
          )}
        </>
      ) : (
        <p class="text-red-500 text-center">Compositeur introuvable.</p>
      )
    }
  </section>
</Layout>
