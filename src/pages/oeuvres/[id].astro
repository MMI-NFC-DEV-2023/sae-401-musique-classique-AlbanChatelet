---
import HeaderPage from "../../components/HeaderPage.astro";
import Layout from "../../layouts/Layout.astro";
import LinkCompositeur from "../../components/LinkCompositeur.astro";
import PocketBase from "pocketbase"; // Importation de PocketBase
import "../../styles/global.css"; // Import propre du CSS

export const prerender = false;

// R√©cup√©ration de l'ID de l'≈ìuvre depuis les param√®tres
const { id } = Astro.params;

if (!id) {
  console.error("‚ùå ID manquant pour la page ≈ìuvre.");
  throw new Error("ID manquant pour la page ≈ìuvre.");
}

// Connexion √† PocketBase via Pockethost
const pb = new PocketBase("https://sae303.pockethost.io"); // Utilisation de l'URL de ton instance Pockethost

let oeuvre = null;

try {
  console.log("üì° Tentative de r√©cup√©ration de l'≈ìuvre depuis PocketBase...");

  // R√©cup√©ration de l'≈ìuvre avec son compositeur
  oeuvre = await pb.collection("oeuvres").getOne(id, {
    expand: "compositeur", // R√©cup√©ration des donn√©es li√©es au compositeur
  });

  console.log("‚úÖ ≈íuvre r√©cup√©r√©e avec succ√®s :", oeuvre);
} catch (error) {
  console.error("‚ùå Erreur lors de la r√©cup√©ration de l'≈ìuvre :", error);
}

const baseUrl = "https://sae303.pockethost.io"; // URL de base de PocketBase
---

<HeaderPage />
<Layout pageTitle={oeuvre ? `D√©tails de ${oeuvre.titre}` : "≈íuvre introuvable"}>
  <section
    class="flex flex-col items-center min-h-screen bg-gradient-to-b from-gray-900 to-gray-700 text-white py-12"
  >
    {
      oeuvre ? (
        <>
          <h1 class="text-4xl font-bold mb-6 tracking-wide">{oeuvre.titre}</h1>

          {/* Affichage du compositeur */}
          {oeuvre.expand?.compositeur && (
            <p class="text-lg">
              Compos√© par :
              <LinkCompositeur
                compositeur={{
                  id: oeuvre.expand.compositeur.id,
                  nom: oeuvre.expand.compositeur.nom,
                }}
              />
            </p>
          )}

          {/* Affichage de la cover de l'≈ìuvre */}
          {oeuvre.cover && (
            <img
              src={`${baseUrl}/api/files/oeuvres/${oeuvre.id}/${oeuvre.cover}`}
              alt={`Photo de ${oeuvre.titre}`}
              class="w-32 h-32 mx-auto mb-4 object-cover"
            />
          )}

          {/* Affichage des autres informations de l'≈ìuvre si disponibles */}
          {oeuvre.annee && <p>Ann√©e de sortie : {oeuvre.annee}</p>}
          {/* Ajouter d'autres informations sp√©cifiques de l'≈ìuvre ici */}
        </>
      ) : (
        <p class="text-red-500 text-center">≈íuvre introuvable.</p>
      )
    }
  </section>
</Layout>
