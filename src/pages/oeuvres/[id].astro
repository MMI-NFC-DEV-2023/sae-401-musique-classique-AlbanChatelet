---
import HeaderPage from "../../components/HeaderPage.astro";
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import LinkCompositeur from "../../components/LinkCompositeur.astro";
import type {
  OeuvresResponse,
  CompositeursResponse,
} from "../../pocketbase-typegen";

import "../../styles/global.css"; // Import propre du CSS

const { id } = Astro.params;

console.log("üîç ID re√ßu depuis les param√®tres :", id);

if (!id) {
  console.error("‚ùå ID manquant pour la page ≈ìuvre.");
  throw new Error("ID manquant pour la page ≈ìuvre.");
}

let oeuvre = null;

try {
  console.log("üì° Tentative de r√©cup√©ration de l'≈ìuvre depuis PocketBase...");

  oeuvre = await Astro.locals.pb
    .collection<
      OeuvresResponse<{ compositeur?: CompositeursResponse }>
    >("oeuvres")
    .getOne(id, { expand: "compositeur" });

  console.log("‚úÖ ≈íuvre r√©cup√©r√©e avec succ√®s :", oeuvre);
} catch (error) {
  console.error("‚ùå Erreur lors de la r√©cup√©ration de l'≈ìuvre :", error);
}
const baseUrl = "http://127.0.0.1:8090"; // URL de base de PocketBase
---

<HeaderPage />
<Layout pageTitle={oeuvre ? `D√©tails de ${oeuvre.titre}` : "≈íuvre introuvable"}>
  <section
    class="flex flex-col items-center min-h-screen bg-gradient-to-b from-gray-900 to-gray-700 text-white py-12"
  >
    {
      oeuvre ? (
        <>
          <h1 class="text-4xl font-bold mb-6 tracking-wide">{oeuvre.titre}</h1>
          {oeuvre.expand?.compositeur && (
            <p class="text-lg">
              Compos√© par :
              <LinkCompositeur
                compositeur={{
                  id: oeuvre.expand.compositeur.id,
                  nom: oeuvre.expand.compositeur.nom,
                }}
              />
            </p>
          )}
          {oeuvre.cover && (
            <img
              src={`${baseUrl}/api/files/oeuvres/${oeuvre.id}/${oeuvre.cover}`}
              alt={`Photo de ${oeuvre.titre}`}
              class="w-32 h-32 mx-auto mb-4 object-cover"
            />
          )}
        </>
      ) : (
        <p class="text-red-500 text-center">≈íuvre introuvable.</p>
      )
    }
  </section>
</Layout>
